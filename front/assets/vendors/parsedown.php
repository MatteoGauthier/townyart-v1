<?php class Parsedown{const version='1.8.0-beta-7';function text($text){$Elements=$this->textElements($text);$markup=$this->elements($Elements);$markup=trim($markup,"\n");return $markup;}protected function textElements($text){$this->DefinitionData=array();$text=str_replace(array("\r\n","\r"),"\n",$text);$text=trim($text,"\n");$lines=explode("\n",$text);return $this->linesElements($lines);}function setBreaksEnabled($breaksEnabled){$this->breaksEnabled=$breaksEnabled;return $this;}protected $breaksEnabled;function setMarkupEscaped($markupEscaped){$this->markupEscaped=$markupEscaped;return $this;}protected $markupEscaped;function setUrlsLinked($urlsLinked){$this->urlsLinked=$urlsLinked;return $this;}protected $urlsLinked=true;function setSafeMode($safeMode){$this->safeMode=(bool) $safeMode;return $this;}protected $safeMode;function setStrictMode($strictMode){$this->strictMode=(bool) $strictMode;return $this;}protected $strictMode;protected $safeLinksWhitelist=array('http://','https://','ftp://','ftps://','mailto:','tel:','data:image/png;base64,','data:image/gif;base64,','data:image/jpeg;base64,','irc:','ircs:','git:','ssh:','news:','steam:',);protected $BlockTypes=array('#'=>array('Header'),'*'=>array('Rule','List'),'+'=>array('List'),'-'=>array('SetextHeader','Table','Rule','List'),'0'=>array('List'),'1'=>array('List'),'2'=>array('List'),'3'=>array('List'),'4'=>array('List'),'5'=>array('List'),'6'=>array('List'),'7'=>array('List'),'8'=>array('List'),'9'=>array('List'),':'=>array('Table'),'<'=>array('Comment','Markup'),'='=>array('SetextHeader'),'>'=>array('Quote'),'['=>array('Reference'),'_'=>array('Rule'),'`'=>array('FencedCode'),'|'=>array('Table'),'~'=>array('FencedCode'),);protected $unmarkedBlockTypes=array('Code',);protected function lines(array $lines){return $this->elements($this->linesElements($lines));}protected function linesElements(array $lines){$Elements=array();$CurrentBlock=null;foreach($lines as $line){if(chop($line)===''){if(isset($CurrentBlock)){$CurrentBlock['interrupted']=(isset($CurrentBlock['interrupted'])?$CurrentBlock['interrupted']+1:1);}continue;}while(($beforeTab=strstr($line,"\t",true))!==false){$shortage=4-mb_strlen($beforeTab,'utf-8')%4;$line=$beforeTab.str_repeat(' ',$shortage).substr($line,strlen($beforeTab)+1);}$indent=strspn($line,' ');$text=$indent>0?substr($line,$indent):$line;$Line=array('body'=>$line,'indent'=>$indent,'text'=>$text);if(isset($CurrentBlock['continuable'])){$methodName='block'.$CurrentBlock['type'].'Continue';$Block=$this->$methodName($Line,$CurrentBlock);if(isset($Block)){$CurrentBlock=$Block;continue;}else{if($this->isBlockCompletable($CurrentBlock['type'])){$methodName='block'.$CurrentBlock['type'].'Complete';$CurrentBlock=$this->$methodName($CurrentBlock);}}}$marker=$text[0];$blockTypes=$this->unmarkedBlockTypes;if(isset($this->BlockTypes[$marker])){foreach($this->BlockTypes[$marker]as $blockType){$blockTypes[]=$blockType;}}foreach($blockTypes as $blockType){$Block=$this->{"block$blockType"}($Line,$CurrentBlock);if(isset($Block)){$Block['type']=$blockType;if(!isset($Block['identified'])){if(isset($CurrentBlock)){$Elements[]=$this->extractElement($CurrentBlock);}$Block['identified']=true;}if($this->isBlockContinuable($blockType)){$Block['continuable']=true;}$CurrentBlock=$Block;continue 2;}}if(isset($CurrentBlock)and $CurrentBlock['type']==='Paragraph'){$Block=$this->paragraphContinue($Line,$CurrentBlock);}if(isset($Block)){$CurrentBlock=$Block;}else{if(isset($CurrentBlock)){$Elements[]=$this->extractElement($CurrentBlock);}$CurrentBlock=$this->paragraph($Line);$CurrentBlock['identified']=true;}}if(isset($CurrentBlock['continuable'])and $this->isBlockCompletable($CurrentBlock['type'])){$methodName='block'.$CurrentBlock['type'].'Complete';$CurrentBlock=$this->$methodName($CurrentBlock);}if(isset($CurrentBlock)){$Elements[]=$this->extractElement($CurrentBlock);}return $Elements;}protected function extractElement(array $Component){if(!isset($Component['element'])){if(isset($Component['markup'])){$Component['element']=array('rawHtml'=>$Component['markup']);}elseif(isset($Component['hidden'])){$Component['element']=array();}}return $Component['element'];}protected function isBlockContinuable($Type){return method_exists($this,'block'.$Type.'Continue');}protected function isBlockCompletable($Type){return method_exists($this,'block'.$Type.'Complete');}protected function blockCode($Line,$Block=null){if(isset($Block)and $Block['type']==='Paragraph'and!isset($Block['interrupted'])){return;}if($Line['indent']>=4){$text=substr($Line['body'],4);$Block=array('element'=>array('name'=>'pre','element'=>array('name'=>'code','text'=>$text,),),);return $Block;}}protected function blockCodeContinue($Line,$Block){if($Line['indent']>=4){if(isset($Block['interrupted'])){$Block['element']['element']['text'].=str_repeat("\n",$Block['interrupted']);unset($Block['interrupted']);}$Block['element']['element']['text'].="\n";$text=substr($Line['body'],4);$Block['element']['element']['text'].=$text;return $Block;}}protected function blockCodeComplete($Block){return $Block;}protected function blockComment($Line){if($this->markupEscaped or $this->safeMode){return;}if(strpos($Line['text'],'<!--')===0){$Block=array('element'=>array('rawHtml'=>$Line['body'],'autobreak'=>true,),);if(strpos($Line['text'],'-->')!==false){$Block['closed']=true;}return $Block;}}protected function blockCommentContinue($Line,array $Block){if(isset($Block['closed'])){return;}$Block['element']['rawHtml'].="\n".$Line['body'];if(strpos($Line['text'],'-->')!==false){$Block['closed']=true;}return $Block;}protected function blockFencedCode($Line){$marker=$Line['text'][0];$openerLength=strspn($Line['text'],$marker);if($openerLength<3){return;}$infostring=trim(substr($Line['text'],$openerLength),"\t ");if(strpos($infostring,'`')!==false){return;}$Element=array('name'=>'code','text'=>'',);if($infostring!==''){$language=substr($infostring,0,strcspn($infostring," \t\n\f\r"));$Element['attributes']=array('class'=>"language-$language");}$Block=array('char'=>$marker,'openerLength'=>$openerLength,'element'=>array('name'=>'pre','element'=>$Element,),);return $Block;}protected function blockFencedCodeContinue($Line,$Block){if(isset($Block['complete'])){return;}if(isset($Block['interrupted'])){$Block['element']['element']['text'].=str_repeat("\n",$Block['interrupted']);unset($Block['interrupted']);}if(($len=strspn($Line['text'],$Block['char']))>=$Block['openerLength']and chop(substr($Line['text'],$len),' ')===''){$Block['element']['element']['text']=substr($Block['element']['element']['text'],1);$Block['complete']=true;return $Block;}$Block['element']['element']['text'].="\n".$Line['body'];return $Block;}protected function blockFencedCodeComplete($Block){return $Block;}protected function blockHeader($Line){$level=strspn($Line['text'],'#');if($level>6){return;}$text=trim($Line['text'],'#');if($this->strictMode and isset($text[0])and $text[0]!==' '){return;}$text=trim($text,' ');$Block=array('element'=>array('name'=>'h'.$level,'handler'=>array('function'=>'lineElements','argument'=>$text,'destination'=>'elements',)),);return $Block;}protected function blockList($Line,array $CurrentBlock=null){list($name,$pattern)=$Line['text'][0]<='-'?array('ul','[*+-]'):array('ol','[0-9]{1,9}+[.\)]');if(preg_match('/^('.$pattern.'([ ]++|$))(.*+)/',$Line['text'],$matches)){$contentIndent=strlen($matches[2]);if($contentIndent>=5){$contentIndent-=1;$matches[1]=substr($matches[1],0,-$contentIndent);$matches[3]=str_repeat(' ',$contentIndent).$matches[3];}elseif($contentIndent===0){$matches[1].=' ';}$markerWithoutWhitespace=strstr($matches[1],' ',true);$Block=array('indent'=>$Line['indent'],'pattern'=>$pattern,'data'=>array('type'=>$name,'marker'=>$matches[1],'markerType'=>($name==='ul'?$markerWithoutWhitespace:substr($markerWithoutWhitespace,-1)),),'element'=>array('name'=>$name,'elements'=>array(),),);$Block['data']['markerTypeRegex']=preg_quote($Block['data']['markerType'],'/');if($name==='ol'){$listStart=ltrim(strstr($matches[1],$Block['data']['markerType'],true),'0')?:'0';if($listStart!=='1'){if(isset($CurrentBlock)and $CurrentBlock['type']==='Paragraph'and!isset($CurrentBlock['interrupted'])){return;}$Block['element']['attributes']=array('start'=>$listStart);}}$Block['li']=array('name'=>'li','handler'=>array('function'=>'li','argument'=>!empty($matches[3])?array($matches[3]):array(),'destination'=>'elements'));$Block['element']['elements'][]=&$Block['li'];return $Block;}}protected function blockListContinue($Line,array $Block){if(isset($Block['interrupted'])and empty($Block['li']['handler']['argument'])){return null;}$requiredIndent=($Block['indent']+strlen($Block['data']['marker']));if($Line['indent']<$requiredIndent and(($Block['data']['type']==='ol'and preg_match('/^[0-9]++'.$Block['data']['markerTypeRegex'].'(?:[ ]++(.*)|$)/',$Line['text'],$matches))or($Block['data']['type']==='ul'and preg_match('/^'.$Block['data']['markerTypeRegex'].'(?:[ ]++(.*)|$)/',$Line['text'],$matches)))){if(isset($Block['interrupted'])){$Block['li']['handler']['argument'][]='';$Block['loose']=true;unset($Block['interrupted']);}unset($Block['li']);$text=isset($matches[1])?$matches[1]:'';$Block['indent']=$Line['indent'];$Block['li']=array('name'=>'li','handler'=>array('function'=>'li','argument'=>array($text),'destination'=>'elements'));$Block['element']['elements'][]=&$Block['li'];return $Block;}elseif($Line['indent']<$requiredIndent and $this->blockList($Line)){return null;}if($Line['text'][0]==='['and $this->blockReference($Line)){return $Block;}if($Line['indent']>=$requiredIndent){if(isset($Block['interrupted'])){$Block['li']['handler']['argument'][]='';$Block['loose']=true;unset($Block['interrupted']);}$text=substr($Line['body'],$requiredIndent);$Block['li']['handler']['argument'][]=$text;return $Block;}if(!isset($Block['interrupted'])){$text=preg_replace('/^[ ]{0,'.$requiredIndent.'}+/','',$Line['body']);$Block['li']['handler']['argument'][]=$text;return $Block;}}protected function blockListComplete(array $Block){if(isset($Block['loose'])){foreach($Block['element']['elements']as&$li){if(end($li['handler']['argument'])!==''){$li['handler']['argument'][]='';}}}return $Block;}protected function blockQuote($Line){if(preg_match('/^>[ ]?+(.*+)/',$Line['text'],$matches)){$Block=array('element'=>array('name'=>'blockquote','handler'=>array('function'=>'linesElements','argument'=>(array) $matches[1],'destination'=>'elements',)),);return $Block;}}protected function blockQuoteContinue($Line,array $Block){if(isset($Block['interrupted'])){return;}if($Line['text'][0]==='>'and preg_match('/^>[ ]?+(.*+)/',$Line['text'],$matches)){$Block['element']['handler']['argument'][]=$matches[1];return $Block;}if(!isset($Block['interrupted'])){$Block['element']['handler']['argument'][]=$Line['text'];return $Block;}}protected function blockRule($Line){$marker=$Line['text'][0];if(substr_count($Line['text'],$marker)>=3 and chop($Line['text']," $marker")===''){$Block=array('element'=>array('name'=>'hr',),);return $Block;}}protected function blockSetextHeader($Line,array $Block=null){if(!isset($Block)or $Block['type']!=='Paragraph'or isset($Block['interrupted'])){return;}if($Line['indent']<4 and chop(chop($Line['text'],' '),$Line['text'][0])===''){$Block['element']['name']=$Line['text'][0]==='='?'h1':'h2';return $Block;}}protected function blockMarkup($Line){if($this->markupEscaped or $this->safeMode){return;}if(preg_match('/^<[\/]?+(\w*)(?:[ ]*+'.$this->regexHtmlAttribute.')*+[ ]*+(\/)?>/',$Line['text'],$matches)){$element=strtolower($matches[1]);if(in_array($element,$this->textLevelElements)){return;}$Block=array('name'=>$matches[1],'element'=>array('rawHtml'=>$Line['text'],'autobreak'=>true,),);return $Block;}}protected function blockMarkupContinue($Line,array $Block){if(isset($Block['closed'])or isset($Block['interrupted'])){return;}$Block['element']['rawHtml'].="\n".$Line['body'];return $Block;}protected function blockReference($Line){if(strpos($Line['text'],']')!==false and preg_match('/^\[(.+?)\]:[ ]*+<?(\S+?)>?(?:[ ]+["\'(](.+)["\')])?[ ]*+$/',$Line['text'],$matches)){$id=strtolower($matches[1]);$Data=array('url'=>$matches[2],'title'=>isset($matches[3])?$matches[3]:null,);$this->DefinitionData['Reference'][$id]=$Data;$Block=array('element'=>array(),);return $Block;}}protected function blockTable($Line,array $Block=null){if(!isset($Block)or $Block['type']!=='Paragraph'or isset($Block['interrupted'])){return;}if(strpos($Block['element']['handler']['argument'],'|')===false and strpos($Line['text'],'|')===false and strpos($Line['text'],':')===false or strpos($Block['element']['handler']['argument'],"\n")!==false){return;}if(chop($Line['text'],' -:|')!==''){return;}$alignments=array();$divider=$Line['text'];$divider=trim($divider);$divider=trim($divider,'|');$dividerCells=explode('|',$divider);foreach($dividerCells as $dividerCell){$dividerCell=trim($dividerCell);if($dividerCell===''){return;}$alignment=null;if($dividerCell[0]===':'){$alignment='left';}if(substr($dividerCell,-1)===':'){$alignment=$alignment==='left'?'center':'right';}$alignments[]=$alignment;}$HeaderElements=array();$header=$Block['element']['handler']['argument'];$header=trim($header);$header=trim($header,'|');$headerCells=explode('|',$header);if(count($headerCells)!==count($alignments)){return;}foreach($headerCells as $index=>$headerCell){$headerCell=trim($headerCell);$HeaderElement=array('name'=>'th','handler'=>array('function'=>'lineElements','argument'=>$headerCell,'destination'=>'elements',));if(isset($alignments[$index])){$alignment=$alignments[$index];$HeaderElement['attributes']=array('style'=>"text-align: $alignment;",);}$HeaderElements[]=$HeaderElement;}$Block=array('alignments'=>$alignments,'identified'=>true,'element'=>array('name'=>'table','elements'=>array(),),);$Block['element']['elements'][]=array('name'=>'thead',);$Block['element']['elements'][]=array('name'=>'tbody','elements'=>array(),);$Block['element']['elements'][0]['elements'][]=array('name'=>'tr','elements'=>$HeaderElements,);return $Block;}protected function blockTableContinue($Line,array $Block){if(isset($Block['interrupted'])){return;}if(count($Block['alignments'])===1 or $Line['text'][0]==='|'or strpos($Line['text'],'|')){$Elements=array();$row=$Line['text'];$row=trim($row);$row=trim($row,'|');preg_match_all('/(?:(\\\\[|])|[^|`]|`[^`]++`|`)++/',$row,$matches);$cells=array_slice($matches[0],0,count($Block['alignments']));foreach($cells as $index=>$cell){$cell=trim($cell);$Element=array('name'=>'td','handler'=>array('function'=>'lineElements','argument'=>$cell,'destination'=>'elements',));if(isset($Block['alignments'][$index])){$Element['attributes']=array('style'=>'text-align: '.$Block['alignments'][$index].';',);}$Elements[]=$Element;}$Element=array('name'=>'tr','elements'=>$Elements,);$Block['element']['elements'][1]['elements'][]=$Element;return $Block;}}protected function paragraph($Line){return array('type'=>'Paragraph','element'=>array('name'=>'p','handler'=>array('function'=>'lineElements','argument'=>$Line['text'],'destination'=>'elements',),),);}protected function paragraphContinue($Line,array $Block){if(isset($Block['interrupted'])){return;}$Block['element']['handler']['argument'].="\n".$Line['text'];return $Block;}protected $InlineTypes=array('!'=>array('Image'),'&'=>array('SpecialCharacter'),'*'=>array('Emphasis'),':'=>array('Url'),'<'=>array('UrlTag','EmailTag','Markup'),'['=>array('Link'),'_'=>array('Emphasis'),'`'=>array('Code'),'~'=>array('Strikethrough'),'\\'=>array('EscapeSequence'),);protected $inlineMarkerList='!*_&[:<`~\\';public function line($text,$nonNestables=array()){return $this->elements($this->lineElements($text,$nonNestables));}protected function lineElements($text,$nonNestables=array()){$text=str_replace(array("\r\n","\r"),"\n",$text);$Elements=array();$nonNestables=(empty($nonNestables)?array():array_combine($nonNestables,$nonNestables));while($excerpt=strpbrk($text,$this->inlineMarkerList)){$marker=$excerpt[0];$markerPosition=strlen($text)-strlen($excerpt);$Excerpt=array('text'=>$excerpt,'context'=>$text);foreach($this->InlineTypes[$marker]as $inlineType){if(isset($nonNestables[$inlineType])){continue;}$Inline=$this->{"inline$inlineType"}($Excerpt);if(!isset($Inline)){continue;}if(isset($Inline['position'])and $Inline['position']>$markerPosition){continue;}if(!isset($Inline['position'])){$Inline['position']=$markerPosition;}$Inline['element']['nonNestables']=isset($Inline['element']['nonNestables'])?array_merge($Inline['element']['nonNestables'],$nonNestables):$nonNestables;$unmarkedText=substr($text,0,$Inline['position']);$InlineText=$this->inlineText($unmarkedText);$Elements[]=$InlineText['element'];$Elements[]=$this->extractElement($Inline);$text=substr($text,$Inline['position']+$Inline['extent']);continue 2;}$unmarkedText=substr($text,0,$markerPosition+1);$InlineText=$this->inlineText($unmarkedText);$Elements[]=$InlineText['element'];$text=substr($text,$markerPosition+1);}$InlineText=$this->inlineText($text);$Elements[]=$InlineText['element'];foreach($Elements as&$Element){if(!isset($Element['autobreak'])){$Element['autobreak']=false;}}return $Elements;}protected function inlineText($text){$Inline=array('extent'=>strlen($text),'element'=>array(),);$Inline['element']['elements']=self::pregReplaceElements($this->breaksEnabled?'/[ ]*+\n/':'/(?:[ ]*+\\\\|[ ]{2,}+)\n/',array(array('name'=>'br'),array('text'=>"\n"),),$text);return $Inline;}protected function inlineCode($Excerpt){$marker=$Excerpt['text'][0];if(preg_match('/^(['.$marker.']++)[ ]*+(.+?)[ ]*+(?<!['.$marker.'])\1(?!'.$marker.')/s',$Excerpt['text'],$matches)){$text=$matches[2];$text=preg_replace('/[ ]*+\n/',' ',$text);return array('extent'=>strlen($matches[0]),'element'=>array('name'=>'code','text'=>$text,),);}}protected function inlineEmailTag($Excerpt){$hostnameLabel='[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?';$commonMarkEmail='[a-zA-Z0-9.!#$%&\'*+\/=?^_`{|}~-]++@'.$hostnameLabel.'(?:\.'.$hostnameLabel.')*';if(strpos($Excerpt['text'],'>')!==false and preg_match("/^<((mailto:)?$commonMarkEmail)>/i",$Excerpt['text'],$matches)){$url=$matches[1];if(!isset($matches[2])){$url="mailto:$url";}return array('extent'=>strlen($matches[0]),'element'=>array('name'=>'a','text'=>$matches[1],'attributes'=>array('href'=>$url,),),);}}protected function inlineEmphasis($Excerpt){if(!isset($Excerpt['text'][1])){return;}$marker=$Excerpt['text'][0];if($Excerpt['text'][1]===$marker and preg_match($this->StrongRegex[$marker],$Excerpt['text'],$matches)){$emphasis='strong';}elseif(preg_match($this->EmRegex[$marker],$Excerpt['text'],$matches)){$emphasis='em';}else{return;}return array('extent'=>strlen($matches[0]),'element'=>array('name'=>$emphasis,'handler'=>array('function'=>'lineElements','argument'=>$matches[1],'destination'=>'elements',)),);}protected function inlineEscapeSequence($Excerpt){if(isset($Excerpt['text'][1])and in_array($Excerpt['text'][1],$this->specialCharacters)){return array('element'=>array('rawHtml'=>$Excerpt['text'][1]),'extent'=>2,);}}protected function inlineImage($Excerpt){if(!isset($Excerpt['text'][1])or $Excerpt['text'][1]!=='['){return;}$Excerpt['text']=substr($Excerpt['text'],1);$Link=$this->inlineLink($Excerpt);if($Link===null){return;}$Inline=array('extent'=>$Link['extent']+1,'element'=>array('name'=>'img','attributes'=>array('src'=>$Link['element']['attributes']['href'],'alt'=>$Link['element']['handler']['argument'],),'autobreak'=>true,),);$Inline['element']['attributes']+=$Link['element']['attributes'];unset($Inline['element']['attributes']['href']);return $Inline;}protected function inlineLink($Excerpt){$Element=array('name'=>'a','handler'=>array('function'=>'lineElements','argument'=>null,'destination'=>'elements',),'nonNestables'=>array('Url','Link'),'attributes'=>array('href'=>null,'title'=>null,),);$extent=0;$remainder=$Excerpt['text'];if(preg_match('/\[((?:[^][]++|(?R))*+)\]/',$remainder,$matches)){$Element['handler']['argument']=$matches[1];$extent+=strlen($matches[0]);$remainder=substr($remainder,$extent);}else{return;}if(preg_match('/^[(]\s*+((?:[^ ()]++|[(][^ )]+[)])++)(?:[ ]+("[^"]*+"|\'[^\']*+\'))?\s*+[)]/',$remainder,$matches)){$Element['attributes']['href']=$matches[1];if(isset($matches[2])){$Element['attributes']['title']=substr($matches[2],1,-1);}$extent+=strlen($matches[0]);}else{if(preg_match('/^\s*\[(.*?)\]/',$remainder,$matches)){$definition=strlen($matches[1])?$matches[1]:$Element['handler']['argument'];$definition=strtolower($definition);$extent+=strlen($matches[0]);}else{$definition=strtolower($Element['handler']['argument']);}if(!isset($this->DefinitionData['Reference'][$definition])){return;}$Definition=$this->DefinitionData['Reference'][$definition];$Element['attributes']['href']=$Definition['url'];$Element['attributes']['title']=$Definition['title'];}return array('extent'=>$extent,'element'=>$Element,);}protected function inlineMarkup($Excerpt){if($this->markupEscaped or $this->safeMode or strpos($Excerpt['text'],'>')===false){return;}if($Excerpt['text'][1]==='/'and preg_match('/^<\/\w[\w-]*+[ ]*+>/s',$Excerpt['text'],$matches)){return array('element'=>array('rawHtml'=>$matches[0]),'extent'=>strlen($matches[0]),);}if($Excerpt['text'][1]==='!'and preg_match('/^<!---?[^>-](?:-?+[^-])*-->/s',$Excerpt['text'],$matches)){return array('element'=>array('rawHtml'=>$matches[0]),'extent'=>strlen($matches[0]),);}if($Excerpt['text'][1]!==' 'and preg_match('/^<\w[\w-]*+(?:[ ]*+'.$this->regexHtmlAttribute.')*+[ ]*+\/?>/s',$Excerpt['text'],$matches)){return array('element'=>array('rawHtml'=>$matches[0]),'extent'=>strlen($matches[0]),);}}protected function inlineSpecialCharacter($Excerpt){if(substr($Excerpt['text'],1,1)!==' 'and strpos($Excerpt['text'],';')!==false and preg_match('/^&(#?+[0-9a-zA-Z]++);/',$Excerpt['text'],$matches)){return array('element'=>array('rawHtml'=>'&'.$matches[1].';'),'extent'=>strlen($matches[0]),);}return;}protected function inlineStrikethrough($Excerpt){if(!isset($Excerpt['text'][1])){return;}if($Excerpt['text'][1]==='~'and preg_match('/^~~(?=\S)(.+?)(?<=\S)~~/',$Excerpt['text'],$matches)){return array('extent'=>strlen($matches[0]),'element'=>array('name'=>'del','handler'=>array('function'=>'lineElements','argument'=>$matches[1],'destination'=>'elements',)),);}}protected function inlineUrl($Excerpt){if($this->urlsLinked!==true or!isset($Excerpt['text'][2])or $Excerpt['text'][2]!=='/'){return;}if(strpos($Excerpt['context'],'http')!==false and preg_match('/\bhttps?+:[\/]{2}[^\s<]+\b\/*+/ui',$Excerpt['context'],$matches,PREG_OFFSET_CAPTURE)){$url=$matches[0][0];$Inline=array('extent'=>strlen($matches[0][0]),'position'=>$matches[0][1],'element'=>array('name'=>'a','text'=>$url,'attributes'=>array('href'=>$url,),),);return $Inline;}}protected function inlineUrlTag($Excerpt){if(strpos($Excerpt['text'],'>')!==false and preg_match('/^<(\w++:\/{2}[^ >]++)>/i',$Excerpt['text'],$matches)){$url=$matches[1];return array('extent'=>strlen($matches[0]),'element'=>array('name'=>'a','text'=>$url,'attributes'=>array('href'=>$url,),),);}}protected function unmarkedText($text){$Inline=$this->inlineText($text);return $this->element($Inline['element']);}protected function handle(array $Element){if(isset($Element['handler'])){if(!isset($Element['nonNestables'])){$Element['nonNestables']=array();}if(is_string($Element['handler'])){$function=$Element['handler'];$argument=$Element['text'];unset($Element['text']);$destination='rawHtml';}else{$function=$Element['handler']['function'];$argument=$Element['handler']['argument'];$destination=$Element['handler']['destination'];}$Element[$destination]=$this->{$function}($argument,$Element['nonNestables']);if($destination==='handler'){$Element=$this->handle($Element);}unset($Element['handler']);}return $Element;}protected function handleElementRecursive(array $Element){return $this->elementApplyRecursive(array($this,'handle'),$Element);}protected function handleElementsRecursive(array $Elements){return $this->elementsApplyRecursive(array($this,'handle'),$Elements);}protected function elementApplyRecursive($closure,array $Element){$Element=call_user_func($closure,$Element);if(isset($Element['elements'])){$Element['elements']=$this->elementsApplyRecursive($closure,$Element['elements']);}elseif(isset($Element['element'])){$Element['element']=$this->elementApplyRecursive($closure,$Element['element']);}return $Element;}protected function elementApplyRecursiveDepthFirst($closure,array $Element){if(isset($Element['elements'])){$Element['elements']=$this->elementsApplyRecursiveDepthFirst($closure,$Element['elements']);}elseif(isset($Element['element'])){$Element['element']=$this->elementsApplyRecursiveDepthFirst($closure,$Element['element']);}$Element=call_user_func($closure,$Element);return $Element;}protected function elementsApplyRecursive($closure,array $Elements){foreach($Elements as&$Element){$Element=$this->elementApplyRecursive($closure,$Element);}return $Elements;}protected function elementsApplyRecursiveDepthFirst($closure,array $Elements){foreach($Elements as&$Element){$Element=$this->elementApplyRecursiveDepthFirst($closure,$Element);}return $Elements;}protected function element(array $Element){if($this->safeMode){$Element=$this->sanitiseElement($Element);}$Element=$this->handle($Element);$hasName=isset($Element['name']);$markup='';if($hasName){$markup.='<'.$Element['name'];if(isset($Element['attributes'])){foreach($Element['attributes']as $name=>$value){if($value===null){continue;}$markup.=" $name=\"".self::escape($value).'"';}}}$permitRawHtml=false;if(isset($Element['text'])){$text=$Element['text'];}elseif(isset($Element['rawHtml'])){$text=$Element['rawHtml'];$allowRawHtmlInSafeMode=isset($Element['allowRawHtmlInSafeMode'])&&$Element['allowRawHtmlInSafeMode'];$permitRawHtml=!$this->safeMode||$allowRawHtmlInSafeMode;}$hasContent=isset($text)||isset($Element['element'])||isset($Element['elements']);if($hasContent){$markup.=$hasName?'>':'';if(isset($Element['elements'])){$markup.=$this->elements($Element['elements']);}elseif(isset($Element['element'])){$markup.=$this->element($Element['element']);}else{if(!$permitRawHtml){$markup.=self::escape($text,true);}else{$markup.=$text;}}$markup.=$hasName?'</'.$Element['name'].'>':'';}elseif($hasName){$markup.=' />';}return $markup;}protected function elements(array $Elements){$markup='';$autoBreak=true;foreach($Elements as $Element){if(empty($Element)){continue;}$autoBreakNext=(isset($Element['autobreak'])?$Element['autobreak']:isset($Element['name']));$autoBreak=!$autoBreak?$autoBreak:$autoBreakNext;$markup.=($autoBreak?"\n":'').$this->element($Element);$autoBreak=$autoBreakNext;}$markup.=$autoBreak?"\n":'';return $markup;}protected function li($lines){$Elements=$this->linesElements($lines);if(!in_array('',$lines)and isset($Elements[0])and isset($Elements[0]['name'])and $Elements[0]['name']==='p'){unset($Elements[0]['name']);}return $Elements;}protected static function pregReplaceElements($regexp,$Elements,$text){$newElements=array();while(preg_match($regexp,$text,$matches,PREG_OFFSET_CAPTURE)){$offset=$matches[0][1];$before=substr($text,0,$offset);$after=substr($text,$offset+strlen($matches[0][0]));$newElements[]=array('text'=>$before);foreach($Elements as $Element){$newElements[]=$Element;}$text=$after;}$newElements[]=array('text'=>$text);return $newElements;}function parse($text){$markup=$this->text($text);return $markup;}protected function sanitiseElement(array $Element){static $goodAttribute='/^[a-zA-Z0-9][a-zA-Z0-9-_]*+$/';static $safeUrlNameToAtt=array('a'=>'href','img'=>'src',);if(!isset($Element['name'])){unset($Element['attributes']);return $Element;}if(isset($safeUrlNameToAtt[$Element['name']])){$Element=$this->filterUnsafeUrlInAttribute($Element,$safeUrlNameToAtt[$Element['name']]);}if(!empty($Element['attributes'])){foreach($Element['attributes']as $att=>$val){if(!preg_match($goodAttribute,$att)){unset($Element['attributes'][$att]);}elseif(self::striAtStart($att,'on')){unset($Element['attributes'][$att]);}}}return $Element;}protected function filterUnsafeUrlInAttribute(array $Element,$attribute){foreach($this->safeLinksWhitelist as $scheme){if(self::striAtStart($Element['attributes'][$attribute],$scheme)){return $Element;}}$Element['attributes'][$attribute]=str_replace(':','%3A',$Element['attributes'][$attribute]);return $Element;}protected static function escape($text,$allowQuotes=false){return htmlspecialchars($text,$allowQuotes?ENT_NOQUOTES:ENT_QUOTES,'UTF-8');}protected static function striAtStart($string,$needle){$len=strlen($needle);if($len>strlen($string)){return false;}else{return strtolower(substr($string,0,$len))===strtolower($needle);}}static function instance($name='default'){if(isset(self::$instances[$name])){return self::$instances[$name];}$instance=new static();self::$instances[$name]=$instance;return $instance;}private static $instances=array();protected $DefinitionData;protected $specialCharacters=array('\\','`','*','_','{','}','[',']','(',')','>','#','+','-','.','!','|','~');protected $StrongRegex=array('*'=>'/^[*]{2}((?:\\\\\*|[^*]|[*][^*]*+[*])+?)[*]{2}(?![*])/s','_'=>'/^__((?:\\\\_|[^_]|_[^_]*+_)+?)__(?!_)/us',);protected $EmRegex=array('*'=>'/^[*]((?:\\\\\*|[^*]|[*][*][^*]+?[*][*])+?)[*](?![*])/s','_'=>'/^_((?:\\\\_|[^_]|__[^_]*__)+?)_(?!_)\b/us',);protected $regexHtmlAttribute='[a-zA-Z_:][\w:.-]*+(?:\s*+=\s*+(?:[^"\'=<>`\s]+|"[^"]*+"|\'[^\']*+\'))?+';protected $voidElements=array('area','base','br','col','command','embed','hr','img','input','link','meta','param','source',);protected $textLevelElements=array('a','br','bdo','abbr','blink','nextid','acronym','basefont','b','em','big','cite','small','spacer','listing','i','rp','del','code','strike','marquee','q','rt','ins','font','strong','s','tt','kbd','mark','u','xm','sub','nobr','sup','ruby','var','span','wbr','time',);}?>
<?php class ParsedownExtra extends Parsedown{const version='0.8.0';function __construct(){if(version_compare(parent::version,'1.7.1')<0){throw new Exception('ParsedownExtra requires a later version of Parsedown');}$this->BlockTypes[':'][]='DefinitionList';$this->BlockTypes['*'][]='Abbreviation';array_unshift($this->BlockTypes['['],'Footnote');array_unshift($this->InlineTypes['['],'FootnoteMarker');}function text($text){$Elements=$this->textElements($text);$markup=$this->elements($Elements);$markup=trim($markup,"\n");$markup=preg_replace('/<\/dl>\s+<dl>\s+/','',$markup);if(isset($this->DefinitionData['Footnote'])){$Element=$this->buildFootnoteElement();$markup.="\n".$this->element($Element);}return $markup;}protected function blockAbbreviation($Line){if(preg_match('/^\*\[(.+?)\]:[ ]*(.+?)[ ]*$/',$Line['text'],$matches)){$this->DefinitionData['Abbreviation'][$matches[1]]=$matches[2];$Block=array('hidden'=>true,);return $Block;}}protected function blockFootnote($Line){if(preg_match('/^\[\^(.+?)\]:[ ]?(.*)$/',$Line['text'],$matches)){$Block=array('label'=>$matches[1],'text'=>$matches[2],'hidden'=>true,);return $Block;}}protected function blockFootnoteContinue($Line,$Block){if($Line['text'][0]==='['and preg_match('/^\[\^(.+?)\]:/',$Line['text'])){return;}if(isset($Block['interrupted'])){if($Line['indent']>=4){$Block['text'].="\n\n".$Line['text'];return $Block;}}else{$Block['text'].="\n".$Line['text'];return $Block;}}protected function blockFootnoteComplete($Block){$this->DefinitionData['Footnote'][$Block['label']]=array('text'=>$Block['text'],'count'=>null,'number'=>null,);return $Block;}protected function blockDefinitionList($Line,$Block){if(!isset($Block)or $Block['type']!=='Paragraph'){return;}$Element=array('name'=>'dl','elements'=>array(),);$terms=explode("\n",$Block['element']['handler']['argument']);foreach($terms as $term){$Element['elements'][]=array('name'=>'dt','handler'=>array('function'=>'lineElements','argument'=>$term,'destination'=>'elements'),);}$Block['element']=$Element;$Block=$this->addDdElement($Line,$Block);return $Block;}protected function blockDefinitionListContinue($Line,array $Block){if($Line['text'][0]===':'){$Block=$this->addDdElement($Line,$Block);return $Block;}else{if(isset($Block['interrupted'])and $Line['indent']===0){return;}if(isset($Block['interrupted'])){$Block['dd']['handler']['function']='textElements';$Block['dd']['handler']['argument'].="\n\n";$Block['dd']['handler']['destination']='elements';unset($Block['interrupted']);}$text=substr($Line['body'],min($Line['indent'],4));$Block['dd']['handler']['argument'].="\n".$text;return $Block;}}protected function blockHeader($Line){$Block=parent::blockHeader($Line);if($Block!==null&&preg_match('/[ #]*{('.$this->regexAttribute.'+)}[ ]*$/',$Block['element']['handler']['argument'],$matches,PREG_OFFSET_CAPTURE)){$attributeString=$matches[1][0];$Block['element']['attributes']=$this->parseAttributeData($attributeString);$Block['element']['handler']['argument']=substr($Block['element']['handler']['argument'],0,$matches[0][1]);}return $Block;}protected function blockMarkup($Line){if($this->markupEscaped or $this->safeMode){return;}if(preg_match('/^<(\w[\w-]*)(?:[ ]*'.$this->regexHtmlAttribute.')*[ ]*(\/)?>/',$Line['text'],$matches)){$element=strtolower($matches[1]);if(in_array($element,$this->textLevelElements)){return;}$Block=array('name'=>$matches[1],'depth'=>0,'element'=>array('rawHtml'=>$Line['text'],'autobreak'=>true,),);$length=strlen($matches[0]);$remainder=substr($Line['text'],$length);if(trim($remainder)===''){if(isset($matches[2])or in_array($matches[1],$this->voidElements)){$Block['closed']=true;$Block['void']=true;}}else{if(isset($matches[2])or in_array($matches[1],$this->voidElements)){return;}if(preg_match('/<\/'.$matches[1].'>[ ]*$/i',$remainder)){$Block['closed']=true;}}return $Block;}}protected function blockMarkupContinue($Line,array $Block){if(isset($Block['closed'])){return;}if(preg_match('/^<'.$Block['name'].'(?:[ ]*'.$this->regexHtmlAttribute.')*[ ]*>/i',$Line['text'])){$Block['depth']++;}if(preg_match('/(.*?)<\/'.$Block['name'].'>[ ]*$/i',$Line['text'],$matches)){if($Block['depth']>0){$Block['depth']--;}else{$Block['closed']=true;}}if(isset($Block['interrupted'])){$Block['element']['rawHtml'].="\n";unset($Block['interrupted']);}$Block['element']['rawHtml'].="\n".$Line['body'];return $Block;}protected function blockMarkupComplete($Block){if(!isset($Block['void'])){$Block['element']['rawHtml']=$this->processTag($Block['element']['rawHtml']);}return $Block;}protected function blockSetextHeader($Line,array $Block=null){$Block=parent::blockSetextHeader($Line,$Block);if($Block!==null&&preg_match('/[ ]*{('.$this->regexAttribute.'+)}[ ]*$/',$Block['element']['handler']['argument'],$matches,PREG_OFFSET_CAPTURE)){$attributeString=$matches[1][0];$Block['element']['attributes']=$this->parseAttributeData($attributeString);$Block['element']['handler']['argument']=substr($Block['element']['handler']['argument'],0,$matches[0][1]);}return $Block;}protected function inlineFootnoteMarker($Excerpt){if(preg_match('/^\[\^(.+?)\]/',$Excerpt['text'],$matches)){$name=$matches[1];if(!isset($this->DefinitionData['Footnote'][$name])){return;}$this->DefinitionData['Footnote'][$name]['count']++;if(!isset($this->DefinitionData['Footnote'][$name]['number'])){$this->DefinitionData['Footnote'][$name]['number']=++$this->footnoteCount;}$Element=array('name'=>'sup','attributes'=>array('id'=>'fnref'.$this->DefinitionData['Footnote'][$name]['count'].':'.$name),'element'=>array('name'=>'a','attributes'=>array('href'=>'#fn:'.$name,'class'=>'footnote-ref'),'text'=>$this->DefinitionData['Footnote'][$name]['number'],),);return array('extent'=>strlen($matches[0]),'element'=>$Element,);}}private $footnoteCount=0;protected function inlineLink($Excerpt){$Link=parent::inlineLink($Excerpt);$remainder=$Link!==null?substr($Excerpt['text'],$Link['extent']):'';if(preg_match('/^[ ]*{('.$this->regexAttribute.'+)}/',$remainder,$matches)){$Link['element']['attributes']+=$this->parseAttributeData($matches[1]);$Link['extent']+=strlen($matches[0]);}return $Link;}private $currentAbreviation;private $currentMeaning;protected function insertAbreviation(array $Element){if(isset($Element['text'])){$Element['elements']=self::pregReplaceElements('/\b'.preg_quote($this->currentAbreviation,'/').'\b/',array(array('name'=>'abbr','attributes'=>array('title'=>$this->currentMeaning,),'text'=>$this->currentAbreviation,)),$Element['text']);unset($Element['text']);}return $Element;}protected function inlineText($text){$Inline=parent::inlineText($text);if(isset($this->DefinitionData['Abbreviation'])){foreach($this->DefinitionData['Abbreviation']as $abbreviation=>$meaning){$this->currentAbreviation=$abbreviation;$this->currentMeaning=$meaning;$Inline['element']=$this->elementApplyRecursiveDepthFirst(array($this,'insertAbreviation'),$Inline['element']);}}return $Inline;}protected function addDdElement(array $Line,array $Block){$text=substr($Line['text'],1);$text=trim($text);unset($Block['dd']);$Block['dd']=array('name'=>'dd','handler'=>array('function'=>'lineElements','argument'=>$text,'destination'=>'elements'),);if(isset($Block['interrupted'])){$Block['dd']['handler']['function']='textElements';unset($Block['interrupted']);}$Block['element']['elements'][]=&$Block['dd'];return $Block;}protected function buildFootnoteElement(){$Element=array('name'=>'div','attributes'=>array('class'=>'footnotes'),'elements'=>array(array('name'=>'hr'),array('name'=>'ol','elements'=>array(),),),);uasort($this->DefinitionData['Footnote'],'self::sortFootnotes');foreach($this->DefinitionData['Footnote']as $definitionId=>$DefinitionData){if(!isset($DefinitionData['number'])){continue;}$text=$DefinitionData['text'];$textElements=parent::textElements($text);$numbers=range(1,$DefinitionData['count']);$backLinkElements=array();foreach($numbers as $number){$backLinkElements[]=array('text'=>' ');$backLinkElements[]=array('name'=>'a','attributes'=>array('href'=>"#fnref$number:$definitionId",'rev'=>'footnote','class'=>'footnote-backref',),'rawHtml'=>'&#8617;','allowRawHtmlInSafeMode'=>true,'autobreak'=>false,);}unset($backLinkElements[0]);$n=count($textElements)-1;if($textElements[$n]['name']==='p'){$backLinkElements=array_merge(array(array('rawHtml'=>'&#160;','allowRawHtmlInSafeMode'=>true,),),$backLinkElements);unset($textElements[$n]['name']);$textElements[$n]=array('name'=>'p','elements'=>array_merge(array($textElements[$n]),$backLinkElements),);}else{$textElements[]=array('name'=>'p','elements'=>$backLinkElements);}$Element['elements'][1]['elements'][]=array('name'=>'li','attributes'=>array('id'=>'fn:'.$definitionId),'elements'=>array_merge($textElements),);}return $Element;}protected function parseAttributeData($attributeString){$Data=array();$attributes=preg_split('/[ ]+/',$attributeString,-1,PREG_SPLIT_NO_EMPTY);foreach($attributes as $attribute){if($attribute[0]==='#'){$Data['id']=substr($attribute,1);}else {$classes[]=substr($attribute,1);}}if(isset($classes)){$Data['class']=implode(' ',$classes);}return $Data;}protected function processTag($elementMarkup){libxml_use_internal_errors(true);$DOMDocument=new DOMDocument;$elementMarkup=mb_convert_encoding($elementMarkup,'HTML-ENTITIES','UTF-8');$DOMDocument->loadHTML($elementMarkup);$DOMDocument->removeChild($DOMDocument->doctype);$DOMDocument->replaceChild($DOMDocument->firstChild->firstChild->firstChild,$DOMDocument->firstChild);$elementText='';if($DOMDocument->documentElement->getAttribute('markdown')==='1'){foreach($DOMDocument->documentElement->childNodes as $Node){$elementText.=$DOMDocument->saveHTML($Node);}$DOMDocument->documentElement->removeAttribute('markdown');$elementText="\n".$this->text($elementText)."\n";}else{foreach($DOMDocument->documentElement->childNodes as $Node){$nodeMarkup=$DOMDocument->saveHTML($Node);if($Node instanceof DOMElement and!in_array($Node->nodeName,$this->textLevelElements)){$elementText.=$this->processTag($nodeMarkup);}else{$elementText.=$nodeMarkup;}}}$DOMDocument->documentElement->nodeValue='placeholder\x1A';$markup=$DOMDocument->saveHTML($DOMDocument->documentElement);$markup=str_replace('placeholder\x1A',$elementText,$markup);return $markup;}protected function sortFootnotes($A,$B){return $A['number']-$B['number'];}protected $regexAttribute='(?:[#.][-\w]+[ ]*)';}?><?php class ParsedownExtraPlugin extends ParsedownExtra{const version='1.3.2';public $abbreviationData=array();public $blockCodeAttributes=array();public $blockCodeClassFormat='language-%s';public $blockCodeHtml=null;public $blockQuoteAttributes=array();public $blockQuoteText=null;public $codeAttributes=array();public $codeAttributesOnParent=false;public $codeHtml=null;public $figureAttributes=array();public $figuresEnabled=false;public $footnoteAttributes=array();public $footnoteBackLinkAttributes=array();public $footnoteBackLinkHtml=null;public $footnoteBackReferenceAttributes=array();public $footnoteLinkAttributes=array();public $footnoteLinkHtml=null;public $footnoteReferenceAttributes=array();public $headerAttributes=array();public $headerText=null;public $imageAttributes=array();public $imageAttributesOnParent=false;public $linkAttributes=array();public $referenceData=array();public $tableAttributes=array();public $tableColumnAttributes=array();public $voidElementSuffix=' />';protected $regexAttribute='(?:[#.][-\w:\\\]+[ ]*|[-\w:\\\]+(?:=(?:["\'][^\n]*?["\']|[^\s]+)?)?[ ]*)';public function __call($key,array $arguments=array()){$property=lcfirst(substr($key,3));if(strpos($key,'set')===0&&property_exists($this,$property)){$this->{$property}=$arguments[0];return $this;}throw new Exception('Method '.$key.' does not exists.');}public function __construct(){if(version_compare(parent::version,'0.8.0-beta-1')<0){throw new Exception('ParsedownExtraPlugin requires a later version of Parsedown');}$this->BlockTypes['!'][]='Image';parent::__construct();}protected function blockAbbreviation($Line){if(preg_match('/^\*\[(.+?)\]:[ ]*$/',$Line['text'],$matches)){$this->DefinitionData['Abbreviation'][$matches[1]]=null;return array('hidden'=>true);}return parent::blockAbbreviation($Line);}protected function blockCodeComplete($Block){$this->doSetAttributes($Block['element']['element'],$this->blockCodeAttributes);$this->doSetContent($Block['element']['element'],$this->blockCodeHtml,true);if($this->codeAttributesOnParent){if($this->codeAttributesOnParent===true){$this->codeAttributesOnParent=array('class','id');}foreach((array) $this->codeAttributesOnParent as $Name){if(isset($Block['element']['element']['attributes'][$Name])){$Block['element']['attributes'][$Name]=$Block['element']['element']['attributes'][$Name];unset($Block['element']['element']['attributes'][$Name]);}}}$Block['element']['element']['rawHtml']=$Block['element']['element']['text'];$Block['element']['element']['allowRawHtmlInSafeMode']=true;unset($Block['element']['element']['text']);return $Block;}protected function blockFencedCode($Line){$Line['text']=strtr(trim($Line['text']),array(' '=>"\x1A",'.'=>"\x1A."));$Attributes=array();if(strpos($Line['text'],'{')!==false&&substr($Line['text'],-1)==='}'){$Parts=explode('{',$Line['text'],2);$Attributes=$this->parseAttributeData(strtr(substr($Parts[1],0,-1),"\x1A",' '));$Line['text']=trim($Parts[0]);}if(!$Block=parent::blockFencedCode($Line)){return;}if($Attributes){$Block['element']['element']['attributes']=$Attributes;}else if(isset($Block['element']['element']['attributes']['class'])){$Classes=explode("\x1A",strtr($Block['element']['element']['attributes']['class'],' ',"\x1A"));$Results=[];foreach($Classes as $Class){if($Class===""||$Class===str_replace('%s',"",$this->blockCodeClassFormat)){continue;}if($Class[0]==='.'){$Results[]=substr($Class,1);}else{$Results[]=sprintf($this->blockCodeClassFormat,$Class);}}$Block['element']['element']['attributes']['class']=implode(' ',array_unique($Results));}return $Block;}protected function blockFencedCodeComplete($Block){return $this->blockCodeComplete($Block);}protected function blockHeader($Line){if(!$Block=parent::blockHeader($Line)){return;}$Level=strspn($Line['text'],'#');$this->doSetAttributes($Block['element'],$this->headerAttributes,array($Level));$this->doSetContent($Block['element'],$this->headerText,false,'argument',array($Level));return $Block;}protected function blockImage($Line){if(!$this->figuresEnabled){return;}if(preg_match('/^\!\[[^\n]*?\](\[[^\n]*?\]|\([^\n]*?\))(\s*\{'.$this->regexAttribute.'+?\})?([ ]{2})?$/',$Line['text'])){$Block=array('description'=>"",'element'=>array('name'=>'figure','attributes'=>array(),'elements'=>array($this->inlineImage($Line))));$this->doSetAttributes($Block['element'],$this->figureAttributes);return $Block;}return;}protected function blockImageComplete($Block){if(!empty($Block['description'])){$Description=$Block['description'];$Block['element']['elements'][]=array('name'=>'figcaption','rawHtml'=>$this->{strpos($Description,"\n\n")===false?'line':'text'}(trim($Description,"\n")));}if($this->imageAttributesOnParent){$Inline=$Block['element']['elements'][0];if($this->imageAttributesOnParent===true){$this->imageAttributesOnParent=array_keys($Inline['element']['attributes']);}foreach((array) $this->imageAttributesOnParent as $Name){if(isset($Inline['element']['attributes'][$Name])){if($Name==='class'&&isset($Block['element']['attributes'][$Name])&&isset($Inline['element']['attributes'][$Name])){$Classes=array_merge(explode(' ',$Block['element']['attributes'][$Name]),explode(' ',$Inline['element']['attributes'][$Name]));sort($Classes);$Block['element']['attributes']['class']=implode(' ',array_unique(array_filter($Classes)));unset($Block['element']['elements'][0]['element']['attributes'][$Name]);continue;}$Block['element']['attributes'][$Name]=$Inline['element']['attributes'][$Name];unset($Block['element']['elements'][0]['element']['attributes'][$Name]);}}}return $Block;}protected function blockImageContinue($Line,array $Block){if(isset($Block['complete'])){return;}if(isset($Block['interrupted'])){$Block['description'].="\n";unset($Block['interrupted']);}if($Line['indent']===0){$Block['complete']=true;return;}if($Line['indent']>0&&$Line['indent']<4){$Block['description'].="\n".$Line['text'];return $Block;}return;}protected function blockQuoteComplete($Block){$this->doSetAttributes($Block['element'],$this->blockQuoteAttributes);$this->doSetContent($Block['element'],$this->blockQuoteText,false,'arguments');return $Block;}protected function blockSetextHeader($Line,array $Block=null){if(!$Block=parent::blockSetextHeader($Line,$Block)){return;}$Level=$Line['text'][0]==='='?1:2;$this->doSetAttributes($Block['element'],$this->headerAttributes,array($Level));$this->doSetContent($Block['element'],$this->headerText,false,'argument',array($Level));return $Block;}protected function blockTableContinue($Line,array $Block){if(!$Block=parent::blockTableContinue($Line,$Block)){return;}$Aligns=$Block['alignments'];foreach($Block['element']['elements']as $Index0=>&$Element0){foreach($Element0['elements']as $Index1=>&$Element1){foreach($Element1['elements']as $Index2=>&$Element2){$this->doSetAttributes($Element2,$this->tableColumnAttributes,array($Aligns[$Index2],$Index2,$Index1));}}}return $Block;}protected function blockTableComplete($Block){$this->doSetAttributes($Block['element'],$this->tableAttributes);return $Block;}protected function buildFootnoteElement(){$DefinitionData=$this->DefinitionData['Footnote'];if(!$Footnotes=parent::buildFootnoteElement()){return;}$DefinitionKey=array_keys($DefinitionData);$DefinitionData=array_values($DefinitionData);$this->doSetAttributes($Footnotes,$this->footnoteAttributes);foreach($Footnotes['elements'][1]['elements']as $Index0=>&$Element0){$Name=$DefinitionKey[$Index0];$Count=$DefinitionData[$Index0]['count'];$Args=array(is_numeric($Name)?(float) $Name:$Name,$Count);$this->doSetAttributes($Element0,$this->footnoteBackReferenceAttributes,$Args);foreach($Element0['elements']as $Index1=>&$Element1){$Count=0;foreach($Element1['elements']as $Index2=>&$Element2){if(!isset($Element2['name'])||$Element2['name']!=='a'){continue;}$Args[1]=++$Count;$this->doSetAttributes($Element2,$this->footnoteBackLinkAttributes,$Args);$this->doSetContent($Element2,$this->footnoteBackLinkHtml,false,'rawHtml');}}}return $Footnotes;}protected function doGetAttributes($Element){if(isset($Element['attributes'])){return (array) $Element['attributes'];}return array();}protected function doGetContent($Element){if(isset($Element['text'])){return $Element['text'];}if(isset($Element['rawHtml'])){return $Element['rawHtml'];}if(isset($Element['handler']['argument'])){return implode("\n",(array) $Element['handler']['argument']);}return null;}private function doSetLink($Excerpt,$Function){if(!$Inline=call_user_func('parent::'.$Function,$Excerpt)){return;}$this->doSetAttributes($Inline['element'],$this->linkAttributes,array($this->isLocal($Inline['element'],'href')));$this->doSetData($this->DefinitionData['Reference'],$this->referenceData);return $Inline;}protected function doSetAttributes(&$Element,$From,$Args=array()){$Attributes=$this->doGetAttributes($Element);$Content=$this->doGetContent($Element);if(is_callable($From)){$Args=array_merge(array($Content,$Attributes,&$Element),$Args);$Element['attributes']=array_replace($Attributes,(array) call_user_func_array($From,$Args));}else{$Element['attributes']=array_replace($Attributes,(array) $From);}}protected function doSetContent(&$Element,$From,$Esc=false,$Mode='text',$Args=array()){$Attributes=$this->doGetAttributes($Element);$Content=$this->doGetContent($Element);if($Esc){$Content=parent::escape($Content,true);}if(is_callable($From)){$Args=array_merge(array($Content,$Attributes,&$Element),$Args);$Content=call_user_func_array($From,$Args);}else if(!empty($From)){$Content=sprintf($From,$Content);}if($Mode==='arguments'){$Element['handler']['argument']=explode("\n",$Content);}else if($Mode==='argument'){$Element['handler']['argument']=$Content;}else{$Element[$Mode]=$Content;}}protected function doSetData(&$To,$From){$To=array_replace((array) $To,(array) $From);}protected function element(array $Element){if(!$Any=parent::element($Element)){return;}if(substr($Any,-3)===' />'){if(is_callable($this->voidElementSuffix)){$Attributes=$this->doGetAttributes($Element);$Content=$this->doGetContent($Element);$Suffix=call_user_func_array($this->voidElementSuffix,[$Content,$Attributes,&$Element]);}else{$Suffix=$this->voidElementSuffix;}$Any=substr_replace($Any,$Suffix,-3);}return $Any;}protected function inlineCode($Excerpt){if(!$Inline=parent::inlineCode($Excerpt)){return;}$this->doSetAttributes($Inline['element'],$this->codeAttributes);$this->doSetContent($Inline['element'],$this->codeHtml,true);$Inline['element']['rawHtml']=$Inline['element']['text'];$Inline['element']['allowRawHtmlInSafeMode']=true;unset($Inline['element']['text']);return $Inline;}protected function inlineFootnoteMarker($Excerpt){if(!$Inline=parent::inlineFootnoteMarker($Excerpt)){return;}$Name=null;if(preg_match('/^\[\^(.+?)\]/',$Excerpt['text'],$matches)){$Name=$matches[1];}$Args=array(is_numeric($Name)?(float) $Name:$Name,$this->DefinitionData['Footnote'][$Name]['count']);$this->doSetAttributes($Inline['element'],$this->footnoteReferenceAttributes,$Args);$this->doSetAttributes($Inline['element']['element'],$this->footnoteLinkAttributes,$Args);$this->doSetContent($Inline['element']['element'],$this->footnoteLinkHtml,false,'text',$Args);$Inline['element']['element']['rawHtml']=$Inline['element']['element']['text'];$Inline['element']['element']['allowRawHtmlInSafeMode']=true;unset($Inline['element']['element']['text']);return $Inline;}protected function inlineImage($Excerpt){if(!$Inline=parent::inlineImage($Excerpt)){return;}$this->doSetAttributes($Inline['element'],$this->imageAttributes,array($this->isLocal($Inline['element'],'src')));return $Inline;}protected function inlineLink($Excerpt){return $this->doSetLink($Excerpt,__FUNCTION__);}protected function inlineText($Text){$this->doSetData($this->DefinitionData['Abbreviation'],$this->abbreviationData);return parent::inlineText($Text);}protected function inlineUrl($Excerpt){return $this->doSetLink($Excerpt,__FUNCTION__);}protected function inlineUrlTag($Excerpt){return $this->doSetLink($Excerpt,__FUNCTION__);}protected function isLocal($Element,$Key){$Link=isset($Element['attributes'][$Key])?(string) $Element['attributes'][$Key]:null;if($Link===""||strpos('./?&#',$Link[0])!==false&&strpos($Link,'//')!==0||strpos($Link,'data:')===0||strpos($Link,'javascript:')===0||strpos($Link,'mailto:')===0){return true;}if(isset($_SERVER['HTTP_HOST'])){$Host=$_SERVER['HTTP_HOST'];}else if(isset($_SERVER['SERVER_NAME'])){$Host=$_SERVER['SERVER_NAME'];}else{$Host="";}if(strpos($Link,'//')===0&&strpos($Link,'//'.$Host)!==0){return false;}if(strpos($Link,'https://'.$Host)===0||strpos($Link,'http://'.$Host)===0){return true;}return strpos($Link,'://')===false;}protected function parseAttributeData($attributeString){$attributeString=strtr($attributeString,array('#'=>' #','.'=>' .'));if(strpos($attributeString,'="')!==false||strpos($attributeString,"='")!==false){$attributeString=preg_replace_callback('#([-\w]+=)(["\'])([^\n]*?)\2#',function($matches){$value=strtr($matches[3],array(' #'=>'#',' .'=>'.',' '=>"\x1A"));return $matches[1].$matches[2].$value.$matches[2];},$attributeString);}$Attributes=array();foreach(explode(' ',$attributeString)as $v){if(!$v){continue;}if($v[0]==='#'&&isset($v[1])){$Attributes['id']=substr($v,1);}else if($v[0]==='.'&&isset($v[1])){$Attributes['class'][]=substr($v,1);}else if(strpos($v,'=')!==false){$vv=explode('=',$v,2);if($vv[1]===""){if($vv[0]==='class'){continue;}$Attributes[$vv[0]]="";}else if($vv[1][0]==='"'&&substr($vv[1],-1)==='"'||$vv[1][0]==="'"&&substr($vv[1],-1)==="'"){$values=stripslashes(strtr(substr(substr($vv[1],1),0,-1),"\x1A",' '));if($vv[0]==='class'&&isset($Attributes[$vv[0]])){$values=explode(' ',$values);$Attributes[$vv[0]]=array_merge($Attributes[$vv[0]],$values);}else{$Attributes[$vv[0]]=$values;}}else{if($vv[0]==='class'&&isset($Attributes[$vv[0]])){$Attributes[$vv[0]]=array_merge($Attributes[$vv[0]],[$vv[1]]);}else{$Attributes[$vv[0]]=$vv[1];}}}else{if($v==='class'&&isset($Attributes[$v])){continue;}$Attributes[$v]=$v;}}if(isset($Attributes['class'])){$Attributes['class']=implode(' ',array_unique((array) $Attributes['class']));}return $Attributes;}}?>